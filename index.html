<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F34 Community Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #0f172a;
            color: #f8fafc;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
        }

        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-8px);
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.5);
        }

        .btn-download {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.4);
        }

        .btn-download:hover {
            box-shadow: 0 15px 25px -5px rgba(59, 130, 246, 0.5);
            transform: scale(1.02);
        }

        .category-pill {
            transition: all 0.3s ease;
        }

        .category-pill.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
    </style>
</head>

<body class="min-h-screen pb-20">
    <!-- Ban Message Overlay -->
    <div id="ban-message" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-6 hidden">
        <div class="glass p-12 max-w-lg w-full text-center border-red-500/20">
            <div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
            </div>
            <h1 class="text-4xl font-black mb-4 text-white uppercase tracking-tighter" id="t-banned-title">You are
                banned</h1>
            <p class="text-slate-400 mb-8 leading-relaxed" id="t-banned-desc">Your access to the community hub has been
                restricted due to a violation of our terms.</p>
            <div class="bg-red-500/5 border border-red-500/10 p-4 rounded-xl mb-8">
                <p class="text-red-400 font-mono text-sm" id="ban-expiry">Ban expires: --</p>
            </div>
            <button id="ban-logout-btn"
                class="w-full py-4 rounded-2xl bg-white text-black font-bold hover:bg-slate-200 transition-colors">Logout</button>
        </div>
    </div>

    <div id="main-content">
        <!-- Header -->
        <header class="max-w-7xl mx-auto px-6 pt-12 pb-8 flex flex-col md:flex-row justify-between items-center gap-8">
            <div class="text-center md:text-left">
                <h1
                    class="text-5xl font-black tracking-tighter bg-gradient-to-r from-white to-slate-500 bg-clip-text text-transparent text-white">
                    F34 Community</h1>
                <p class="text-slate-400 mt-2 text-lg font-light" id="t-subtitle">Discover and download shared
                    configurations</p>
            </div>
            <div class="flex flex-wrap justify-center items-center gap-4">
                <!-- Language Switcher -->
                <div class="glass p-1 flex gap-1 text-[10px] font-bold uppercase tracking-widest">
                    <button onclick="setLang('en')" id="lang-en"
                        class="px-3 py-1.5 rounded-lg transition-all hover:bg-white/5">EN</button>
                    <button onclick="setLang('ko')" id="lang-ko"
                        class="px-3 py-1.5 rounded-lg transition-all hover:bg-white/5">KO</button>
                    <button onclick="setLang('jp')" id="lang-jp"
                        class="px-3 py-1.5 rounded-lg transition-all hover:bg-white/5">JP</button>
                    <button onclick="setLang('cn')" id="lang-cn"
                        class="px-3 py-1.5 rounded-lg transition-all hover:bg-white/5">CN</button>
                    <button onclick="setLang('es')" id="lang-es"
                        class="px-3 py-1.5 rounded-lg transition-all hover:bg-white/5">ES</button>
                    <button onclick="setLang('fr')" id="lang-fr"
                        class="px-3 py-1.5 rounded-lg transition-all hover:bg-white/5">FR</button>
                    <button onclick="setLang('de')" id="lang-de"
                        class="px-3 py-1.5 rounded-lg transition-all hover:bg-white/5">DE</button>
                    <button onclick="setLang('ru')" id="lang-ru"
                        class="px-3 py-1.5 rounded-lg transition-all hover:bg-white/5">RU</button>
                </div>
                <button onclick="openSupportModal()" class="glass px-6 py-3 font-bold hover:bg-white/5 transition-all"
                    id="t-support">Support</button>
                <a href="admin.html" id="t-admin-panel"
                    class="glass px-6 py-3 font-bold hover:bg-white/5 transition-all hidden">Admin Panel</a>
                <button id="auth-btn"
                    class="glass px-8 py-3 font-bold hover:bg-white/10 transition-all border border-white/10">
                    Login with Google
                </button>
            </div>
        </header>

        <!-- Categories -->
        <div class="max-w-7xl mx-auto px-6 mb-12">
            <div id="category-list" class="flex flex-wrap gap-2 justify-center">
                <!-- Categories will be injected here -->
            </div>
        </div>

        <!-- Main Grid -->
        <main class="max-w-7xl mx-auto px-6">
            <div id="config-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="col-span-full glass p-20 text-center">
                    <div id="loading-spinner"
                        class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4">
                    </div>
                    <p class="text-xl text-slate-400 font-light" id="t-loading">Loading configurations...</p>
                    <p class="text-xs text-slate-600 mt-4" id="debug-status"></p>
                </div>
            </div>
        </main>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="fixed inset-0 z-50 flex items-center justify-center p-6 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="glass max-w-4xl w-full max-h-[90vh] overflow-y-auto relative z-10 p-8 md:p-12 animate-fade-in">
            <button onclick="closeModal()"
                class="absolute top-8 right-8 text-slate-400 hover:text-white transition-colors">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <div id="modal-content">
                <div class="mb-12">
                    <h2 id="modal-title" class="text-4xl font-black tracking-tighter mb-2">Config Details</h2>
                    <div class="h-1 w-20 bg-blue-500 rounded-full"></div>
                </div>
                <div id="modal-body" class="space-y-8">
                    <!-- Details will be injected here -->
                </div>
                <div class="mt-12 pt-8 border-t border-white/5 flex justify-end gap-4">
                    <button onclick="closeModal()"
                        class="px-8 py-4 rounded-2xl glass font-bold hover:bg-white/5 transition-all"
                        id="t-close">Close</button>
                    <button id="modal-download-btn"
                        class="btn-download px-12 py-4 rounded-2xl font-bold text-white transition-all">Download</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Modal -->
    <div id="support-modal" class="fixed inset-0 z-50 flex items-center justify-center p-6 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeSupportModal()"></div>
        <div class="glass max-w-2xl w-full relative z-10 p-8 animate-fade-in">
            <h2 class="text-3xl font-black mb-6" id="t-support-title">Customer Center</h2>
            <p class="text-slate-400 mb-6" id="t-support-desc">Have a problem or suggestion? Send us a message.</p>
            <textarea id="support-message"
                class="w-full h-40 bg-black/20 border border-white/10 rounded-2xl p-4 text-white focus:outline-none focus:border-blue-500 transition-colors mb-6"
                placeholder="Describe your issue..."></textarea>
            <div class="flex justify-end gap-4">
                <button onclick="closeSupportModal()"
                    class="px-6 py-3 rounded-xl glass font-bold hover:bg-white/5 transition-all"
                    id="t-support-cancel">Cancel</button>
                <button onclick="submitTicket()"
                    class="btn-download px-8 py-3 rounded-xl font-bold text-white transition-all"
                    id="t-support-submit">Submit Ticket</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { initializeFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, increment, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, signInWithRedirect, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA827pUzqfTpGpGbT9uKXKEjZo3hYl5ENo",
            authDomain: "f34-di.firebaseapp.com",
            projectId: "f34-di",
            storageBucket: "f34-di.firebasestorage.app",
            messagingSenderId: "660590227115",
            appId: "1:660590227115:web:0f1ca3aa9464f2406c11ee"
        };

        const i18n = {
            en: {
                subtitle: "Discover and download shared configurations",
                loading: "Loading configurations...",
                noConfigs: "No configurations found yet.",
                noResults: "No configurations match this category.",
                login: "Login with Google",
                linkMod: "Link Minecraft (Login in Mod)",
                loggedInAs: "Logged in as",
                logout: "Logout",
                download: "Download",
                details: "View Details",
                loginToDownload: "Login to Download",
                link: "Link Account",
                loginAlert: "Please login first.",
                linkAlert: "Please link your Minecraft account first by logging in through the F34 mod.",
                modalTitle: "Configuration Details",
                info: "Information",
                author: "Author",
                category: "Category",
                downloads: "Downloads",
                description: "Description",
                noDesc: "No description provided.",
                buttons: "Buttons",
                noButtons: "No custom buttons in this config.",
                raw: "Raw Configuration Data",
                close: "Close",
                support: "Support",
                supportTitle: "Customer Center",
                supportDesc: "Have a problem or suggestion? Send us a message.",
                supportSuccess: "Ticket submitted successfully!",
                supportError: "Failed to submit ticket.",
                bannedTitle: "You are banned",
                bannedDesc: "Your access to the community hub has been restricted due to a violation of our terms.",
                categories: {
                    All: "All", Adventure: "Adventure", Horror: "Horror", Decoration: "Decoration", Economy: "Economy", Equipment: "Equipment", Food: "Food", "Game Mechanics": "Game Mechanics", Library: "Library", Magic: "Magic", Management: "Management", Minigame: "Minigame", Mobs: "Mobs", Optimization: "Optimization", Social: "Social", Storage: "Storage", Technology: "Technology", Transportation: "Transportation", Utility: "Utility", "World Gen": "World Gen", General: "General", Convenience: "Convenience"
                }
            },
            ko: {
                subtitle: "공유된 설정을 탐색하고 다운로드하세요",
                loading: "설정을 불러오는 중...",
                noConfigs: "아직 공유된 설정이 없습니다.",
                noResults: "이 카테고리에 해당하는 설정이 없습니다.",
                login: "Google로 로그인",
                linkMod: "마인크래프트 연동 필요 (모드에서 로그인)",
                loggedInAs: "로그인됨:",
                logout: "로그아웃",
                download: "다운로드",
                details: "상세 보기",
                loginToDownload: "로그인 후 다운로드",
                link: "계정 연동",
                loginAlert: "먼저 로그인해주세요.",
                linkAlert: "F34 모드에서 로그인하여 마인크래프트 계정을 먼저 연동해주세요.",
                modalTitle: "설정 상세 정보",
                info: "정보",
                author: "제작자",
                category: "카테고리",
                downloads: "다운로드 수",
                description: "설명",
                noDesc: "설명이 없습니다.",
                buttons: "버튼 구성",
                noButtons: "이 설정에는 커스텀 버튼이 없습니다.",
                raw: "원본 데이터",
                close: "닫기",
                support: "고객 센터",
                supportTitle: "고객 센터",
                supportDesc: "문제나 제안 사항이 있으신가요? 메시지를 보내주세요.",
                supportSuccess: "문의가 성공적으로 접수되었습니다!",
                supportError: "문의 접수에 실패했습니다.",
                bannedTitle: "당신은 차단 되었습니다.",
                bannedDesc: "이용 약관 위반으로 인해 커뮤니티 허브 접속이 제한되었습니다.",
                categories: {
                    All: "전체", Adventure: "모험", Horror: "공포", Decoration: "장식", Economy: "경제", Equipment: "장비", Food: "음식", "Game Mechanics": "게임 매커니즘", Library: "라이브러리", Magic: "마법", Management: "관리", Minigame: "미니게임", Mobs: "몹", Optimization: "최적화", Social: "소셜", Storage: "저장", Technology: "기술", Transportation: "운송", Utility: "유틸리티", "World Gen": "월드 생성", General: "일반", Convenience: "편의"
                }
            }
        };

        let currentLang = localStorage.getItem('f34_lang') || 'en';
        let db, auth, provider;
        let currentUser = null;
        let mcAccount = null;
        let allConfigs = [];
        let currentCategory = 'All';
        let dataLoaded = false;
        let fetchTimeout = null;

        function log(msg, isDebug = false) {
            console.log(`[F34] ${msg}`);
            if (isDebug) {
                const debugEl = document.getElementById('debug-status');
                if (debugEl) debugEl.textContent = msg;
            }
        }

        window.setLang = (lang) => {
            currentLang = lang;
            localStorage.setItem('f34_lang', lang);
            updateUI();
        };

        function updateUI() {
            const t = i18n[currentLang] || i18n.en;
            document.getElementById('t-subtitle').textContent = t.subtitle;
            if (!dataLoaded) document.getElementById('t-loading').textContent = t.loading;
            document.getElementById('t-support').textContent = t.support;
            document.getElementById('t-close').textContent = t.close;
            document.getElementById('t-banned-title').textContent = t.bannedTitle;
            document.getElementById('t-banned-desc').textContent = t.bannedDesc;

            const authBtn = document.getElementById('auth-btn');
            if (!currentUser) authBtn.textContent = t.login;
            else if (!mcAccount) authBtn.textContent = t.linkMod;

            document.querySelectorAll('[id^="lang-"]').forEach(btn => {
                btn.classList.remove('bg-white/10', 'text-blue-400');
                if (btn.id === `lang-${currentLang}`) btn.classList.add('bg-white/10', 'text-blue-400');
            });

            renderCategories();
            renderConfigs();
        }

        function renderCategories() {
            const t = i18n[currentLang] || i18n.en;
            const container = document.getElementById('category-list');
            if (!container) return;
            container.innerHTML = '';
            Object.keys(t.categories).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `category-pill px-4 py-2 rounded-full glass text-xs font-bold uppercase tracking-wider ${currentCategory === cat ? 'active' : 'hover:bg-white/5'}`;
                btn.textContent = t.categories[cat];
                btn.onclick = () => {
                    currentCategory = cat;
                    renderCategories();
                    renderConfigs();
                };
                container.appendChild(btn);
            });
        }

        function renderConfigs() {
            if (!dataLoaded) return;
            const t = i18n[currentLang] || i18n.en;
            const configList = document.getElementById('config-list');
            if (!configList) return;

            const filtered = currentCategory === 'All' ? allConfigs : allConfigs.filter(c => c.category === currentCategory);

            if (filtered.length === 0) {
                configList.innerHTML = `<div class="col-span-full glass p-12 text-center text-xl">${allConfigs.length === 0 ? t.noConfigs : t.noResults}</div>`;
                return;
            }

            configList.innerHTML = '';
            filtered.forEach(data => {
                const div = document.createElement('div');
                div.className = "glass p-8 card-hover flex flex-col justify-between animate-fade-in";
                div.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold">${data.name || 'Untitled'}</h3>
                                <span class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">${t.categories[data.category] || data.category || 'General'}</span>
                            </div>
                            <span class="text-[10px] opacity-40 font-mono">${data.downloads || 0} DLs</span>
                        </div>
                        <p class="text-slate-400 text-xs mt-1">by ${data.author ? data.author.split('@')[0] : 'Unknown'}</p>
                        <p class="mt-4 text-sm text-slate-300 line-clamp-2">"${data.description || t.noDesc}"</p>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="showDetails('${data.id}')" class="flex-1 py-3 rounded-xl glass font-bold hover:bg-white/10 transition-colors">${t.details}</button>
                        <button onclick="handleDownload('${data.id}')" class="btn-download flex-1 py-3 rounded-xl font-bold text-white transition-transform active:scale-95 ${(!currentUser || !mcAccount) ? 'opacity-50 cursor-not-allowed' : ''}">${(currentUser && mcAccount) ? t.download : (currentUser ? t.link : t.loginToDownload)}</button>
                    </div>
                `;
                configList.appendChild(div);
            });
        }

        // --- REST API Fallback ---
        async function fetchConfigsREST() {
            log("Attempting REST API fallback...", true);
            try {
                const url = `https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/shared_configs?mask.fieldPaths=name&mask.fieldPaths=author&mask.fieldPaths=category&mask.fieldPaths=description&mask.fieldPaths=downloads&mask.fieldPaths=status&mask.fieldPaths=config_json`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.documents) {
                    allConfigs = data.documents
                        .map(doc => {
                            const fields = doc.fields;
                            const id = doc.name.split('/').pop();
                            return {
                                id: id,
                                name: fields.name?.stringValue,
                                author: fields.author?.stringValue,
                                category: fields.category?.stringValue,
                                description: fields.description?.stringValue,
                                downloads: parseInt(fields.downloads?.integerValue || 0),
                                status: fields.status?.stringValue,
                                config_json: fields.config_json?.stringValue
                            };
                        })
                        .filter(c => c.status === 'approved');
                    dataLoaded = true;
                    log("REST API fetch successful.", true);
                    renderConfigs();
                }
            } catch (e) {
                log("REST Fallback Error: " + e.message, true);
            }
        }

        window.showDetails = (id) => {
            const data = allConfigs.find(c => c.id === id);
            if (!data) return;
            const t = i18n[currentLang] || i18n.en;
            const modal = document.getElementById('details-modal');
            const modalBody = document.getElementById('modal-body');
            const modalDownloadBtn = document.getElementById('modal-download-btn');
            document.getElementById('modal-title').textContent = t.modalTitle;

            let configObj = {};
            try { configObj = JSON.parse(data.config_json); } catch (e) { }

            modalBody.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-xs uppercase tracking-widest opacity-40 font-bold mb-4">${t.info}</h4>
                        <div class="space-y-4">
                            <div><div class="text-[10px] opacity-40">${t.author}</div><div class="font-semibold text-blue-400">${data.author || 'Unknown'}</div></div>
                            <div><div class="text-[10px] opacity-40">${t.category}</div><div class="font-semibold">${t.categories[data.category] || data.category || 'General'}</div></div>
                            <div><div class="text-[10px] opacity-40">${t.downloads}</div><div class="font-semibold">${data.downloads || 0}</div></div>
                        </div>
                        <h4 class="text-xs uppercase tracking-widest opacity-40 font-bold mt-8 mb-4">${t.description}</h4>
                        <p class="text-slate-300 leading-relaxed">"${data.description || t.noDesc}"</p>
                    </div>
                    <div>
                        <h4 class="text-xs uppercase tracking-widest opacity-40 font-bold mb-4">${t.buttons} (${configObj.buttons ? configObj.buttons.length : 0})</h4>
                        <div class="space-y-3">
                            ${(configObj.buttons || []).map(btn => `
                                <div class="glass p-3 rounded-xl border border-white/5">
                                    <div class="text-sm font-bold">${btn.name || 'Unnamed'}</div>
                                    <div class="text-[10px] font-mono opacity-50 break-all">${btn.command || ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            modalDownloadBtn.textContent = t.download;
            modalDownloadBtn.onclick = () => window.handleDownload(id);
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        window.closeModal = () => {
            document.getElementById('details-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        };

        window.handleDownload = async (id) => {
            const t = i18n[currentLang] || i18n.en;
            if (!currentUser) { alert(t.loginAlert); return; }
            if (!mcAccount) { alert(t.linkAlert); return; }
            try {
                const data = allConfigs.find(c => c.id === id);
                if (!data) return;
                const blob = new Blob([data.config_json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${data.name.replaceAll(' ', '_')}.json`;
                a.click();
                URL.revokeObjectURL(url);
                await updateDoc(doc(db, "shared_configs", id), { downloads: increment(1) });
            } catch (e) { alert("Download failed."); }
        };

        window.openSupportModal = () => {
            if (!currentUser) { alert(i18n[currentLang].loginAlert); return; }
            document.getElementById('support-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        window.closeSupportModal = () => {
            document.getElementById('support-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        };

        window.submitTicket = async () => {
            const t = i18n[currentLang] || i18n.en;
            const msg = document.getElementById('support-message').value.trim();
            if (!msg) return;
            try {
                await addDoc(collection(db, "support_tickets"), {
                    email: currentUser.email,
                    mc_name: mcAccount ? mcAccount.mc_name : 'Unknown',
                    message: msg,
                    timestamp: Date.now()
                });
                alert(t.supportSuccess);
                document.getElementById('support-message').value = '';
                closeSupportModal();
            } catch (e) { alert(t.supportError); }
        };

        // --- Firebase Logic ---
        try {
            const app = initializeApp(firebaseConfig);
            db = initializeFirestore(app, { experimentalForceLongPolling: true });
            auth = getAuth(app);
            provider = new GoogleAuthProvider();

            onAuthStateChanged(auth, async (user) => {
                currentUser = user;
                const t = i18n[currentLang] || i18n.en;
                const authBtn = document.getElementById('auth-btn');
                const adminPanelBtn = document.getElementById('t-admin-panel');
                const banMessage = document.getElementById('ban-message');
                const mainContent = document.getElementById('main-content');

                if (user) {
                    log(`User logged in: ${user.email}`, true);
                    try {
                        const userDoc = await getDoc(doc(db, "users", user.email));
                        if (userDoc.exists()) {
                            mcAccount = userDoc.data();
                            if (mcAccount.ban_until && mcAccount.ban_until > Date.now()) {
                                banMessage.classList.remove('hidden');
                                mainContent.classList.add('hidden');
                                document.getElementById('ban-expiry').textContent = `Ban expires: ${new Date(mcAccount.ban_until).toLocaleString()}`;
                                return;
                            }
                            if (mcAccount.mc_name === 'minseokkangfox') adminPanelBtn.classList.remove('hidden');
                            authBtn.innerHTML = `<div class="flex items-center gap-3"><img src="https://mc-heads.net/avatar/${mcAccount.mc_name}/32" class="w-8 h-8 rounded border border-white/20"><div class="text-left"><div class="text-[10px] opacity-50">${t.loggedInAs}</div><div class="font-bold">${mcAccount.mc_name}</div></div></div>`;
                        } else {
                            authBtn.textContent = t.linkMod;
                        }
                    } catch (e) { log("Auth Doc Error: " + e.message); }
                } else {
                    authBtn.textContent = t.login;
                    adminPanelBtn.classList.add('hidden');
                    banMessage.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                }
                updateUI();
            });

            document.getElementById('auth-btn').onclick = async () => {
                if (currentUser) signOut(auth);
                else {
                    try {
                        await signInWithPopup(auth, provider).catch(async (err) => {
                            if (['auth/popup-blocked', 'auth/popup-closed-by-user', 'auth/cancelled-popup-request'].includes(err.code)) await signInWithRedirect(auth, provider);
                            else throw err;
                        });
                    } catch (e) { alert("Login failed: " + e.message); }
                }
            };

            document.getElementById('ban-logout-btn').onclick = () => signOut(auth);

            // Fetch shared configs with timeout fallback
            const q = query(collection(db, "shared_configs"), where("status", "==", "approved"));
            onSnapshot(q, (snap) => {
                if (fetchTimeout) clearTimeout(fetchTimeout);
                allConfigs = [];
                snap.forEach(doc => allConfigs.push({ id: doc.id, ...doc.data() }));
                dataLoaded = true;
                log(`Fetched ${allConfigs.length} configs via SDK`, true);
                renderConfigs();
            }, (err) => {
                log("SDK Fetch Error: " + err.message, true);
                if (!dataLoaded) fetchConfigsREST();
            });

            fetchTimeout = setTimeout(() => {
                if (!dataLoaded) {
                    log("SDK hang detected, switching to REST...", true);
                    fetchConfigsREST();
                }
            }, 5000);

            updateUI();
        } catch (e) { log("Init Error: " + e.message); }
    </script>
</body>

</html>
