<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F34 Community Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1a1c2c, #0d0e14);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-download {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .icon-badge {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filter-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-12">
            <div>
                <h1
                    class="text-4xl font-bold text-white bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                    F34 Community</h1>
                <p class="text-slate-400 mt-2">Discover and download shared configurations</p>
            </div>
            <div class="flex items-center gap-4">
                <a href="admin.html"
                    class="px-6 py-2 rounded-lg glass hover:bg-white/10 transition-colors text-sm">Admin Panel</a>
                <button id="auth-btn"
                    class="px-6 py-2 rounded-lg glass hover:bg-white/10 transition-colors text-sm">Login with
                    Google</button>
            </div>
        </header>

        <div class="mb-8">
            <div id="category-filter" class="flex flex-wrap gap-2">
                <button
                    class="filter-btn active px-4 py-2 rounded-lg glass text-[10px] font-bold uppercase tracking-wider transition-all"
                    data-category="all">All</button>
            </div>
        </div>

        <div id="config-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="loading-state" class="col-span-full glass p-12 text-center text-xl animate-pulse">
                Loading configurations...
                <div class="text-xs opacity-50 mt-2" id="debug-status">Initializing Firebase...</div>
            </div>
        </div>
    </div>

    <script type="module">
        const statusEl = document.getElementById('debug-status');
        const log = (msg) => {
            console.log(`[F34] ${msg}`);
            if (statusEl) {
                const div = document.createElement('div');
                div.textContent = msg;
                statusEl.appendChild(div);
            }
        };

        log("Script starting...");

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { initializeFirestore, collection, query, where, onSnapshot, getDocs, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA827pUzqfTpGpGbT9uKXKEjZo3hYl5ENo",
            authDomain: "f34-di.firebaseapp.com",
            projectId: "f34-di",
            storageBucket: "f34-di.firebasestorage.app",
            messagingSenderId: "660590227115",
            appId: "1:660590227115:web:0f1ca3aa9464f2406c11ee"
        };

        try {
            log("Initializing App...");
            const app = initializeApp(firebaseConfig);

            log("Initializing Firestore (Long Polling)...");
            const db = initializeFirestore(app, {
                experimentalForceLongPolling: true
            });

            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();

            const configList = document.getElementById('config-list');
            const filterContainer = document.getElementById('category-filter');
            const authBtn = document.getElementById('auth-btn');

            let currentUser = null;
            let mcAccount = null;
            let currentCategory = 'all';
            let allConfigs = [];

            log("Checking redirect result...");
            getRedirectResult(auth).then((result) => {
                if (result) log("Redirect login: " + result.user.email);
                else log("No redirect result.");
            }).catch((error) => {
                log("Redirect Error: " + error.code);
            });

            log("Setting up Auth listener...");
            onAuthStateChanged(auth, async (user) => {
                log("Auth state: " + (user ? user.email : "Logged out"));
                currentUser = user;
                if (user) {
                    try {
                        const userDoc = await getDoc(doc(db, "users", user.email));
                        if (userDoc.exists()) {
                            mcAccount = userDoc.data();
                            authBtn.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <img src="https://mc-heads.net/avatar/${mcAccount.mc_name}/32" class="w-8 h-8 rounded border border-white/20" alt="Skin">
                                    <div class="text-left">
                                        <div class="text-[10px] opacity-50 leading-none">Logged in as</div>
                                        <div class="font-bold">${mcAccount.mc_name}</div>
                                    </div>
                                </div>
                            `;
                            authBtn.classList.add('bg-white/5');
                        } else {
                            mcAccount = null;
                            authBtn.textContent = 'Link Minecraft (Login in Mod)';
                        }
                    } catch (e) {
                        log("User Doc Error: " + e.message);
                    }
                } else {
                    mcAccount = null;
                    authBtn.textContent = 'Login with Google';
                    authBtn.classList.remove('bg-white/5');
                }
                renderConfigs();
            });

            authBtn.onclick = async () => {
                if (currentUser) {
                    signOut(auth);
                } else {
                    try {
                        await signInWithPopup(auth, provider).catch(async (error) => {
                            if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                                await signInWithRedirect(auth, provider);
                            } else {
                                throw error;
                            }
                        });
                    } catch (error) {
                        alert('Login failed: ' + error.message);
                    }
                }
            };

            const CATEGORIES = [
                "Adventure", "Horror", "Decoration", "Economy", "Equipment", "Food",
                "Game Mechanics", "Library", "Magic", "Management", "Minigame", "Mobs",
                "Optimization", "Social", "Storage", "Technology", "Transportation",
                "Utility", "World Gen", "General", "Convenience"
            ];

            CATEGORIES.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn px-4 py-2 rounded-lg glass text-[10px] font-bold uppercase tracking-wider transition-all';
                btn.textContent = cat;
                btn.dataset.category = cat;
                btn.onclick = () => setFilter(cat);
                filterContainer.appendChild(btn);
            });

            document.querySelector('[data-category="all"]').onclick = () => setFilter('all');

            function setFilter(cat) {
                currentCategory = cat;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.category === cat);
                });
                renderConfigs();
            }

            const q = query(collection(db, "shared_configs"), where("status", "==", "approved"));
            const qAll = collection(db, "shared_configs");

            // Diagnostic: Test REST API
            log("Testing REST API...");
            fetch(`https://firestore.googleapis.com/v1/projects/f34-di/databases/(default)/documents/shared_configs?pageSize=1`)
                .then(r => {
                    log("REST Status: " + r.status);
                    return r.json();
                })
                .then(data => {
                    if (data.error) log("REST Error: " + data.error.message);
                    else log("REST Success: Found " + (data.documents ? data.documents.length : 0) + " docs");
                })
                .catch(e => log("REST Failed: " + e.message));

            log("Fetching data (filtered)...");
            const fetchTimeout = setTimeout(() => {
                log("Filtered fetch hang. Trying un-filtered...");
                getDocs(qAll).then(snap => {
                    log("Un-filtered success! Count: " + snap.size);
                    if (snap.size > 0) {
                        allConfigs = [];
                        snap.forEach(doc => {
                            const data = doc.data();
                            if (data.status === 'approved') allConfigs.push({ id: doc.id, ...data });
                        });
                        renderConfigs();
                    }
                }).catch(err => {
                    log("Un-filtered Error: " + err.message);
                });
            }, 8000);

            getDocs(q).then((snapshot) => {
                clearTimeout(fetchTimeout);
                log("Filtered fetch complete. Count: " + snapshot.size);
                allConfigs = [];
                snapshot.forEach(doc => {
                    allConfigs.push({ id: doc.id, ...doc.data() });
                });
                renderConfigs();

                log("Setting up real-time listener...");
                onSnapshot(q, (snap) => {
                    log("Update received. Count: " + snap.size);
                    allConfigs = [];
                    snap.forEach(doc => {
                        allConfigs.push({ id: doc.id, ...doc.data() });
                    });
                    renderConfigs();
                }, (err) => {
                    log("Snapshot Error: " + err.code);
                });
            }).catch((err) => {
                clearTimeout(fetchTimeout);
                log("Fetch Error: " + err.message);
            });

            function renderConfigs() {
                const filtered = currentCategory === 'all'
                    ? allConfigs
                    : allConfigs.filter(c => c.category === currentCategory);

                if (filtered.length === 0 && allConfigs.length > 0) {
                    configList.innerHTML = '<div class="col-span-full glass p-12 text-center text-xl">No configurations found in this category.</div>';
                    return;
                } else if (allConfigs.length === 0) {
                    return;
                }

                configList.innerHTML = '';
                filtered.forEach((data) => {
                    const div = document.createElement('div');
                    div.className = 'glass p-6 card-hover flex flex-col justify-between';

                    let btnSummary = '';
                    try {
                        const config = JSON.parse(data.config_json);
                        if (config.buttons) {
                            btnSummary = `<div class="flex flex-wrap gap-2 mt-4">
                                ${config.buttons.slice(0, 4).map(b => `<span class="icon-badge px-2 py-1 rounded text-[10px]">${b.name || 'Button'}</span>`).join('')}
                                ${config.buttons.length > 4 ? `<span class="opacity-40 text-[10px]">+${config.buttons.length - 4} more</span>` : ''}
                            </div>`;
                        }
                    } catch (e) { }

                    div.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold">${data.name || 'Untitled'}</h3>
                                    <span class="text-[10px] text-blue-400 font-bold uppercase tracking-wider">${data.category || 'General'}</span>
                                </div>
                                <span class="text-[10px] opacity-40 font-mono">${data.downloads || 0} DLs</span>
                            </div>
                            <p class="text-slate-400 text-xs mt-1">by ${data.author ? data.author.split('@')[0] : 'Unknown'}</p>
                            <p class="mt-4 text-sm text-slate-300 line-clamp-2">"${data.description || 'No description.'}"</p>
                            ${btnSummary}
                        </div>
                        <button onclick="handleDownload('${data.id}')" class="btn-download mt-6 w-full py-3 rounded-xl font-bold text-white transition-transform active:scale-95 ${(!currentUser || !mcAccount) ? 'opacity-50 cursor-not-allowed' : ''}">${(currentUser && mcAccount) ? 'Download' : (currentUser ? 'Link Minecraft' : 'Login to Download')}</button>
                    `;
                    configList.appendChild(div);
                });
            }

            window.handleDownload = async (id) => {
                if (!currentUser) {
                    alert('Please login with Google to download configurations.');
                    signInWithRedirect(auth, provider);
                    return;
                }
                if (!mcAccount) {
                    alert('Your Google account is not linked with Minecraft. Please login using the F34 mod in Minecraft first.');
                    return;
                }
                try {
                    const docRef = doc(db, "shared_configs", id);
                    const snap = await getDoc(docRef);
                    if (!snap.exists()) return;
                    const data = snap.data();
                    const blob = new Blob([data.config_json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${data.name.replaceAll(' ', '_')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    await updateDoc(docRef, { downloads: increment(1) });
                } catch (e) {
                    alert("Download failed.");
                }
            };
        } catch (globalError) {
            log("Global Init Error: " + globalError.message);
        }
    </script>
</body>

</html>
