<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F34 Community Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1a1c2c, #0d0e14);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-download {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .icon-badge {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-12">
            <div>
                <h1
                    class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                    F34 Community</h1>
                <p class="text-slate-400 mt-2">Discover and download shared configurations</p>
            </div>
            <a href="../admin/admin.html"
                class="px-6 py-2 rounded-lg glass hover:bg-white/10 transition-colors text-sm">Admin Panel</a>
        </header>
        <div id="config-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>

    <!-- Language Modal -->
    <div id="lang-modal"
        class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="glass p-8 max-w-sm w-full mx-4">
            <h2 class="text-2xl font-bold mb-4">Select Language</h2>
            <div id="lang-options" class="space-y-3"></div>
            <button onclick="closeModal()"
                class="mt-6 w-full py-2 text-slate-400 hover:text-white transition-colors">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyA827pUzqfTpGpGbT9uKXKEjZo3hYl5ENo",
            authDomain: "f34-di.firebaseapp.com",
            projectId: "f34-di",
            storageBucket: "f34-di.firebasestorage.app",
            messagingSenderId: "660590227115",
            appId: "1:660590227115:web:0f1ca3aa9464f2406c11ee"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const configList = document.getElementById('config-list');
        const langModal = document.getElementById('lang-modal');
        const langOptions = document.getElementById('lang-options');

        let currentConfig = null;

        const q = query(collection(db, "shared_configs"), where("status", "==", "approved"));
        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                configList.innerHTML = '<div class="col-span-full glass p-12 text-center text-xl">No configurations shared yet.</div>';
                return;
            }
            configList.innerHTML = '';
            snapshot.forEach((doc) => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'glass p-6 card-hover flex flex-col justify-between';

                let btnSummary = '';
                try {
                    const config = JSON.parse(data.config_json);
                    if (config.buttons) {
                        btnSummary = `<div class="flex flex-wrap gap-2 mt-4">
                            ${config.buttons.slice(0, 4).map(b => `<span class="icon-badge px-2 py-1 rounded text-[10px]">${b.name}</span>`).join('')}
                            ${config.buttons.length > 4 ? `<span class="opacity-40 text-[10px]">+${config.buttons.length - 4} more</span>` : ''}
                        </div>`;
                    }
                } catch (e) { }

                div.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold">${data.name}</h3>
                            <span class="text-[10px] opacity-40 font-mono">${data.downloads || 0} DLs</span>
                        </div>
                        <p class="text-slate-400 text-xs mt-1">by ${data.author.split('@')[0]}</p>
                        <p class="mt-4 text-sm text-slate-300 line-clamp-2">"${data.description}"</p>
                        ${btnSummary}
                    </div>
                    <button onclick="handleDownload('${doc.id}')" class="btn-download mt-6 w-full py-3 rounded-xl font-bold text-white transition-transform active:scale-95">Download</button>
                `;
                configList.appendChild(div);
            });
        });

        window.handleDownload = async (id) => {
            const docRef = doc(db, "shared_configs", id);
            onSnapshot(docRef, (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                currentConfig = data;
                currentConfig.id = id;

                if (data.translation_requested && data.translations && Object.keys(data.translations).length > 0) {
                    showLangModal(data.translations);
                } else {
                    downloadJson(data.config_json, data.name);
                    incrementDownloads(id);
                }
            }, { once: true });
        };

        function showLangModal(translations) {
            langOptions.innerHTML = '';
            // Add Original
            const origBtn = document.createElement('button');
            origBtn.className = 'w-full py-3 px-4 rounded-xl bg-white/5 hover:bg-white/10 text-left font-medium transition-colors';
            origBtn.innerHTML = `Original Language`;
            origBtn.onclick = () => {
                downloadJson(currentConfig.config_json, currentConfig.name);
                incrementDownloads(currentConfig.id);
                closeModal();
            };
            langOptions.appendChild(origBtn);

            // Add Translations
            for (const [lang, tData] of Object.entries(translations)) {
                const btn = document.createElement('button');
                btn.className = 'w-full py-3 px-4 rounded-xl bg-blue-500/10 hover:bg-blue-500/20 text-left font-medium border border-blue-500/20 transition-colors';
                btn.innerHTML = `${lang.toUpperCase()} - ${tData.name}`;
                btn.onclick = () => {
                    const config = JSON.parse(currentConfig.config_json);
                    config.name = tData.name;
                    if (tData.buttons) {
                        tData.buttons.forEach((tBtn, i) => {
                            if (config.buttons[i]) config.buttons[i].name = tBtn.translated;
                        });
                    }
                    downloadJson(JSON.stringify(config), tData.name);
                    incrementDownloads(currentConfig.id);
                    closeModal();
                };
                langOptions.appendChild(btn);
            }
            langModal.classList.remove('hidden');
        }

        window.closeModal = () => langModal.classList.add('hidden');

        function downloadJson(json, name) {
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replaceAll(' ', '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function incrementDownloads(id) {
            const docRef = doc(db, "shared_configs", id);
            await updateDoc(docRef, { downloads: increment(1) });
        }
    </script>
</body>

</html>
